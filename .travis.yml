language: cpp
dist: xenial
osx_image: xcode10.1

env:
  global:
    - SCONS_CACHE="$HOME/.scons_cache"
    - SCONS_CACHE_LIMIT=1024

cache:
  directories:
    - $SCONS_CACHE

matrix:
  include:
    - name: Linux Debug + Static Checks
      os: linux
      compiler: gcc
      env: TARGET=debug STATIC_CHECKS=yes
      addons:
        apt:
          packages:
            - clang-format-8
            - [scons, pkg-config, build-essential, p7zip-full]

    - name: Linux Release
      os: linux
      compiler: gcc
      addons:
        apt:
          packages:
            - [scons, pkg-config, build-essential, p7zip-full]
      env: TARGET=release

    - name: macOS Debug
      os: osx
      compiler: clang
      env:
        - TARGET=debug
        - HOMEBREW_NO_AUTO_UPDATE=1

    - name: macOS Release
      os: osx
      compiler: clang
      env:
        - TARGET=release
        - HOMEBREW_NO_AUTO_UPDATE=1

    - name: Windows MSVC Debug
      os: windows
      env: TARGET=debug

    - name: Windows MSVC Release
      os: windows
      env: TARGET=release

install:
  - if [[ "$TRAVIS_OS_NAME" == "osx" ]]; then
      brew install scons p7zip;
      curl -LO https://downloads.tuxfamily.org/godotengine/3.2.3/Godot_v3.2.3-stable_osx.64.zip;
      unzip Godot_v3.2.3-stable_osx.64.zip;
    fi

  - if [[ "$TRAVIS_OS_NAME" == "windows" ]]; then
      curl -LO https://downloads.sourceforge.net/project/scons/scons-local/3.1.2/scons-local-3.1.2.zip;
      unzip scons-local-3.1.2.zip;
      curl -LO https://downloads.tuxfamily.org/godotengine/3.2.3/Godot_v3.2.3-stable_win64.exe.zip;
      unzip Godot_v3.2.3-stable_win64.exe.zip;
    fi

  - if [[ "$TRAVIS_OS_NAME" == "linux" ]]; then
      curl -LO https://downloads.tuxfamily.org/godotengine/3.2.3/Godot_v3.2.3-stable_linux_server.64.zip;
      unzip Godot_v3.2.3-stable_linux_server.64.zip;
    fi

script:
  - if [[ "$TRAVIS_OS_NAME" == "windows" ]]; then
      export SCONS="./scons.bat";
    else
      export SCONS="scons";
    fi

  - if [[ "$TRAVIS_OS_NAME" == "windows" ]]; then
      export GODOT="./Godot_v3.2.3-stable_win64.exe";
    elif [[ "$TRAVIS_OS_NAME" == "osx" ]]; then
      export GODOT="./Godot.app/Contents/MacOS/Godot";
    else
      export GODOT="./Godot_v3.2.3-stable_linux_server.64";
    fi 

  - $SCONS target="$TARGET" bits=64 generate_bindings=yes $SCONS_FLAGS;

  - if [[ "$STATIC_CHECKS" == "yes" ]]; then
      sh ./misc/travis/clang-format.sh;
    fi

  - if [[ "$TRAVIS_OS_NAME" != "windows" ]]; then
      $SCONS target="$TARGET" platform="$TRAVIS_OS_NAME" bits=64 $SCONS_FLAGS -C test;
      $GODOT --path test -s script.gd;
    fi
